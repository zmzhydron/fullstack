<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <div id="app"></div>
  <div id="app1"></div>
  <div id="app2"></div>
</body>
<script>
  function isObject(val) {
      return val !== null && typeof val === 'object'
    }
  // 将对象定义为响应式
    function reactive(data) {
        Object.keys(data).forEach(key => {
          defineReactive(data, key)
        })
      return data
    }
    function defineReactive(data, key) {
      let val = data[key]
      const dep = new Dep()
      Object.defineProperty(data, key, {
        get() {
          console.log(data,key,val, `defineProperty`);
          dep.depend()
          return val
        },
        set(newVal) {
          val = newVal
          dep.notify()
        }
      })
      if (isObject(val)) {
        reactive(val)
      }
    }
    function watch(getter, callback) {
      new Watcher(getter, { watch: true, callback })
    }
    function computed(getter) {
        let def = {}
        const computedWatcher = new Watcher(getter, { computed: true })
        Object.defineProperty(def, 'value', {
          get() {
            computedWatcher.depend()
            return computedWatcher.get()
          }
        })
        return def
      }
    class Dep {
      constructor(key) {
        this.key = key
        this.deps = new Set()
      }
      depend() {
        console.log(Dep.target, `Dep.depend`);
        if (Dep.target) {
          this.deps.add(Dep.target)
        }
        console.log(this.deps, 'this.deps');
      }
      notify() {
        this.deps.forEach(watcher => watcher.update())
      }
    }
    Dep.target = null
    const targetStack = []

    function pushTarget(_target) {
      console.log(`targetStack`, targetStack, Dep.target, _target);
      if (Dep.target) targetStack.push(Dep.target)
      Dep.target = _target
    }
    function popTarget() {
      Dep.target = targetStack.pop()
    }
    class Watcher {
        constructor(getter, options = {}) {
          const { computed, watch, callback } = options
          this.getter = getter
          this.computed = computed
          this.watch = watch
          this.callback = callback
          this.value = undefined
          console.log(this, `Watcher  constructor`);
          if (computed) {
            this.dep = new Dep()
          } else {
            this.get()
          }
        }

        get() {
          pushTarget(this)
          console.log(this.value, 'watcher.get before', this);
          this.value = this.getter()
          console.log(this.value, 'watcher.get after', this);
          popTarget()
          return this.value
        }

        // 仅为computed使用
        depend() {
          this.dep.depend(this)
        }

        update() {
          if (this.computed) {
            this.get()
            this.dep.notify()
          } else if (this.watch) {
            const oldValue = this.value
            this.get()
            this.callback(oldValue, this.value)
          } else {
            this.get()
          }
        }
      }

  const data = reactive({
      msg: 'Hello World',
      number: 1
    })

    const numberPlusOne = computed(() => data.number + 1)
    // data.msg = 'shitnigger';
    new Watcher(() => {
      console.log("Watcher RENDER HTML ~~~~~~~~`");
      document.getElementById('app').innerHTML = `
    <p>请在控制台输入data，分别改变data.msg尝试效果</p>
    <p>data.msg被watch了，可以打印出新旧值的变化</p>
    msg is ${data.msg} <br>
  `
    })
  //       new Watcher(() => {
  //           document.getElementById('app2').innerHTML = `${data.msg}`
  //         })

  //   new Watcher(() => {
  //     document.getElementById('app2').innerHTML = `
  // <p>请在控制台改变data.number尝试computed效果</p>
  // <p>data.number现在是${data.number}</p>
  //   computed: 1 + number 是 ${numberPlusOne.value}
  // `
  //   })
    // watch(
    //   () => data.msg,
    //   (old, newVal) => {
    //     console.log('old: ', old)
    //     console.log('newVal: ', newVal)
    //   }
    // )

    window.data = data
    window.numberPlusOneFN = () => {
      console.log(numberPlusOne);
      return numberPlusOne;
    }
</script>
</html>